// Prisma schema for 選情系統

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// ==================== 使用者 ====================

model User {
  id         String   @id @default(uuid())
  lineUserId String   @unique @map("line_user_id")
  name       String
  email      String?
  phone      String?
  avatarUrl  String?  @map("avatar_url")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // 帳號停用
  isSuspended   Boolean   @default(false) @map("is_suspended")
  suspendedAt   DateTime? @map("suspended_at")
  suspendReason String?   @map("suspend_reason")

  // 管理員權限
  isAdmin      Boolean @default(false) @map("is_admin")
  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // 推薦系統
  referralCode String? @unique @map("referral_code")

  // Google Calendar 整合
  googleAccessToken  String?   @map("google_access_token")
  googleRefreshToken String?   @map("google_refresh_token")
  googleTokenExpiry  DateTime? @map("google_token_expiry")
  googleCalendarId   String?   @map("google_calendar_id")

  // Relations
  campaigns        Campaign[]
  teamMembers      TeamMember[]
  contacts         Contact[]
  schedules        Schedule[]
  activityLogs     ActivityLog[]
  createdVoters    Voter[]               @relation("VoterCreator")
  createdEvents    Event[]
  recordedMeetings RelationshipMeeting[] @relation("MeetingRecorder")
  createdInvites   CampaignInvite[]      @relation("InviteCreator")
  subscriptions    Subscription[]
  adminActionLogs  AdminActionLog[]      @relation("AdminActionLogs")
  referralsGiven   Referral[]            @relation("ReferrerUser")
  referralReceived Referral?             @relation("ReferredUser")

  // 推廣者系統
  promoter            Promoter?           @relation("PromoterUser")
  approvedPromoters   Promoter[]          @relation("PromoterApprover")
  promoterReferrals   PromoterReferral?   @relation("PromoterReferred")
  trialActivations    TrialInvite?        @relation("TrialActivatedUser")

  @@map("users")
}

// ==================== 管理員操作記錄 ====================

model AdminActionLog {
  id         String   @id @default(uuid())
  adminId    String   @map("admin_id") // 執行操作的管理員 User ID
  action     String // 操作類型: USER_SUSPEND, SUBSCRIPTION_UPDATE, PAYMENT_REFUND 等
  targetType String   @map("target_type") // 目標類型: USER, SUBSCRIPTION, PAYMENT
  targetId   String   @map("target_id") // 目標 ID
  details    Json? // 操作詳情
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  admin User @relation("AdminActionLogs", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("admin_action_logs")
}

// ==================== 推薦系統 ====================

model Referral {
  id              String         @id @default(uuid())
  referrerUserId  String         @map("referrer_user_id")
  referredUserId  String         @unique @map("referred_user_id")
  referralCode    String         @map("referral_code")
  status          ReferralStatus @default(PENDING)
  rewardGrantedAt DateTime?      @map("reward_granted_at")
  rewardMonths    Int            @default(1) @map("reward_months")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  referrer User @relation("ReferrerUser", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referred User @relation("ReferredUser", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@index([referrerUserId])
  @@index([referralCode])
  @@index([status])
  @@index([createdAt])
  @@map("referrals")
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  campaignId String?  @map("campaign_id")
  action     String
  entity     String
  entityId   String?  @map("entity_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([campaignId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ==================== 選舉活動 ====================

model Campaign {
  id           String       @id @default(uuid())
  ownerId      String       @map("owner_id")
  name         String
  electionType ElectionType @map("election_type")
  electionDate DateTime?    @map("election_date")
  city         String
  district     String?
  village      String?
  constituency Int?
  description  String?
  isActive     Boolean      @default(true) @map("is_active")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // 資料保留與刪除（Phase 4）
  gracePeriodEndsAt DateTime? @map("grace_period_ends_at")
  markedForDeletion Boolean   @default(false) @map("marked_for_deletion")
  deletedAt         DateTime? @map("deleted_at")

  // Relations
  owner        User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  teamMembers  TeamMember[]
  invites      CampaignInvite[]
  voters       Voter[]
  contacts     Contact[]
  events       Event[]
  schedules    Schedule[]
  activityLogs ActivityLog[]

  @@index([ownerId])
  @@index([isActive])
  @@map("campaigns")
}

model TeamMember {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  campaignId String   @map("campaign_id")
  role       UserRole @default(VIEWER)
  invitedBy  String?  @map("invited_by")
  joinedAt   DateTime @default(now()) @map("joined_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
  @@map("team_members")
}

model CampaignInvite {
  id         String   @id @default(uuid())
  campaignId String   @map("campaign_id")
  code       String   @unique
  role       UserRole @default(VIEWER)
  createdBy  String   @map("created_by")
  expiresAt  DateTime @map("expires_at")
  maxUses    Int?     @map("max_uses")
  usedCount  Int      @default(0) @map("used_count")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator  User     @relation("InviteCreator", fields: [createdBy], references: [id])

  @@index([campaignId])
  @@index([code])
  @@map("campaign_invites")
}

// ==================== 選民 ====================

model Voter {
  id             String                                @id @default(uuid())
  campaignId     String                                @map("campaign_id")
  name           String
  phone          String?
  email          String?
  lineId         String?                               @map("line_id")
  lineUrl        String?                               @map("line_url")
  address        String?
  city           String?
  districtName   String?                               @map("district_name")
  village        String?
  neighborhood   String?
  // PostGIS geometry 欄位
  location       Unsupported("geometry(Point, 4326)")?
  latitude       Float?
  longitude      Float?
  politicalParty PoliticalParty?                       @map("political_party")
  stance         PoliticalStance                       @default(UNDECIDED)
  influenceScore Int                                   @default(0) @map("influence_score")
  age            Int?
  gender         Gender?
  occupation     String?
  tags           String[]                              @default([])
  notes          String?
  contactCount   Int                                   @default(0) @map("contact_count")
  lastContactAt  DateTime?                             @map("last_contact_at")
  createdBy      String                                @map("created_by")
  createdAt      DateTime                              @default(now()) @map("created_at")
  updatedAt      DateTime                              @updatedAt @map("updated_at")

  // Relations
  campaign          Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creator           User                @relation("VoterCreator", fields: [createdBy], references: [id])
  contacts          Contact[]
  hostedEvents      Event[]             @relation("EventHost")
  eventAttendances  EventAttendee[]
  scheduleItems     ScheduleItem[]
  relationshipsFrom VoterRelationship[] @relation("RelationshipSource")
  relationshipsTo   VoterRelationship[] @relation("RelationshipTarget")

  @@index([campaignId])
  @@index([stance])
  @@index([influenceScore])
  @@index([createdAt])
  @@index([lineId])
  @@index([lineUrl])
  @@map("voters")
}

model VoterRelationship {
  id              String       @id @default(uuid())
  sourceVoterId   String       @map("source_voter_id")
  targetVoterId   String       @map("target_voter_id")
  relationType    RelationType @map("relation_type")
  influenceWeight Int          @default(50) @map("influence_weight")
  notes           String?
  createdAt       DateTime     @default(now()) @map("created_at")

  // 見面次數追蹤
  meetingCount    Int       @default(1) @map("meeting_count")
  firstMetAt      DateTime? @map("first_met_at")
  lastMetAt       DateTime? @map("last_met_at")
  firstMetEventId String?   @map("first_met_event_id")

  // Relations
  sourceVoter   Voter                 @relation("RelationshipSource", fields: [sourceVoterId], references: [id], onDelete: Cascade)
  targetVoter   Voter                 @relation("RelationshipTarget", fields: [targetVoterId], references: [id], onDelete: Cascade)
  firstMetEvent Event?                @relation("FirstMetRelations", fields: [firstMetEventId], references: [id], onDelete: SetNull)
  meetings      RelationshipMeeting[]

  @@unique([sourceVoterId, targetVoterId])
  @@map("voter_relationships")
}

model RelationshipMeeting {
  id             String   @id @default(uuid())
  relationshipId String   @map("relationship_id")
  eventId        String?  @map("event_id")
  meetingDate    DateTime @default(now()) @map("meeting_date")
  location       String?
  notes          String?
  recordedBy     String   @map("recorded_by")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  relationship VoterRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  event        Event?            @relation("MeetingEvents", fields: [eventId], references: [id], onDelete: SetNull)
  recorder     User              @relation("MeetingRecorder", fields: [recordedBy], references: [id])

  @@index([relationshipId])
  @@index([eventId])
  @@map("relationship_meetings")
}

// ==================== 接觸紀錄 ====================

model Contact {
  id           String         @id @default(uuid())
  voterId      String         @map("voter_id")
  userId       String         @map("user_id")
  campaignId   String         @map("campaign_id")
  type         ContactType
  outcome      ContactOutcome
  contactDate  DateTime       @default(now()) @map("contact_date")
  location     String?
  locationLat  Float?         @map("location_lat")
  locationLng  Float?         @map("location_lng")
  notes        String?
  topics       String[]       @default([])
  nextAction   String?        @map("next_action")
  followUpDate DateTime?      @map("follow_up_date")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Relations
  voter    Voter    @relation(fields: [voterId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([voterId])
  @@index([userId])
  @@index([campaignId])
  @@index([contactDate])
  @@map("contacts")
}

// ==================== 活動 ====================

model Event {
  id                String      @id @default(uuid())
  campaignId        String      @map("campaign_id")
  type              EventType
  status            EventStatus @default(PLANNED)
  name              String
  description       String?
  hostVoterId       String?     @map("host_voter_id")
  address           String?
  locationLat       Float?      @map("location_lat")
  locationLng       Float?      @map("location_lng")
  startTime         DateTime    @map("start_time")
  endTime           DateTime?   @map("end_time")
  expectedAttendees Int?        @map("expected_attendees")
  actualAttendees   Int?        @map("actual_attendees")
  notes             String?
  createdBy         String      @map("created_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  campaign              Campaign              @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  host                  Voter?                @relation("EventHost", fields: [hostVoterId], references: [id], onDelete: SetNull)
  creator               User                  @relation(fields: [createdBy], references: [id])
  attendees             EventAttendee[]
  scheduleItems         ScheduleItem[]
  firstMetRelationships VoterRelationship[]   @relation("FirstMetRelations")
  relationshipMeetings  RelationshipMeeting[] @relation("MeetingEvents")

  @@index([campaignId])
  @@index([startTime])
  @@index([status])
  @@map("events")
}

model EventAttendee {
  id          String         @id @default(uuid())
  eventId     String         @map("event_id")
  voterId     String         @map("voter_id")
  status      AttendeeStatus @default(INVITED)
  invitedBy   String?        @map("invited_by")
  checkedInAt DateTime?      @map("checked_in_at")
  notes       String?
  createdAt   DateTime       @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  voter Voter @relation(fields: [voterId], references: [id], onDelete: Cascade)

  @@unique([eventId, voterId])
  @@map("event_attendees")
}

// ==================== 行程 ====================

model Schedule {
  id                String         @id @default(uuid())
  campaignId        String         @map("campaign_id")
  userId            String         @map("user_id")
  date              DateTime
  title             String
  description       String?
  status            ScheduleStatus @default(DRAFT)
  totalDistance     Float?         @map("total_distance")
  estimatedDuration Int?           @map("estimated_duration")
  actualDuration    Int?           @map("actual_duration")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  // Google Calendar 同步
  googleEventId String?   @map("google_event_id")
  lastSyncedAt  DateTime? @map("last_synced_at")
  syncEnabled   Boolean   @default(false) @map("sync_enabled")

  // Relations
  campaign Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items    ScheduleItem[]

  @@index([campaignId])
  @@index([userId])
  @@index([date])
  @@map("schedules")
}

model ScheduleItem {
  id             String             @id @default(uuid())
  scheduleId     String             @map("schedule_id")
  order          Int
  type           ScheduleItemType
  voterId        String?            @map("voter_id")
  eventId        String?            @map("event_id")
  address        String?
  locationLat    Float?             @map("location_lat")
  locationLng    Float?             @map("location_lng")
  plannedTime    DateTime?          @map("planned_time")
  actualTime     DateTime?          @map("actual_time")
  duration       Int?
  status         ScheduleItemStatus @default(PENDING)
  notes          String?
  travelDistance Float?             @map("travel_distance")
  travelDuration Int?               @map("travel_duration")
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  voter    Voter?   @relation(fields: [voterId], references: [id], onDelete: SetNull)
  event    Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([scheduleId])
  @@map("schedule_items")
}

// ==================== 選區 ====================

model District {
  id               String                                       @id @default(uuid())
  name             String
  level            DistrictLevel
  parentId         String?                                      @map("parent_id")
  code             String?
  registeredVoters Int?                                         @map("registered_voters")
  boundary         Unsupported("geometry(MultiPolygon, 4326)")?
  centerLat        Float?                                       @map("center_lat")
  centerLng        Float?                                       @map("center_lng")
  createdAt        DateTime                                     @default(now()) @map("created_at")
  updatedAt        DateTime                                     @updatedAt @map("updated_at")

  // Self-relation for hierarchy
  parent   District?  @relation("DistrictHierarchy", fields: [parentId], references: [id])
  children District[] @relation("DistrictHierarchy")

  @@unique([name, level, parentId])
  @@index([level])
  @@index([parentId])
  @@map("districts")
}

// ==================== 訂閱與付款 ====================

model Plan {
  id         String       @id @default(uuid())
  name       String // 方案名稱
  code       String       @unique // 方案代碼 (FREE_TRIAL, MONTHLY, YEARLY)
  price      Int // 價格（新台幣）
  interval   PlanInterval // 計費週期
  voterLimit Int?         @map("voter_limit") // 選民數量上限 (null = 無限)
  teamLimit  Int?         @map("team_limit") // 團隊成員上限
  features   Json         @default("[]") // 功能清單
  isActive   Boolean      @default(true) @map("is_active")
  sortOrder  Int          @default(0) @map("sort_order")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  // 戰區分級定價
  city            String? // 縣市名稱（用於分級定價）
  category        PlanCategory? // 方案類別（里長/民代/議員等）
  regionLevel     Int?          @map("region_level") // 戰區等級 1-5
  populationRatio Decimal?      @map("population_ratio") @db.Decimal(10, 4) // 人口比例係數
  basePrice       Int?          @map("base_price") // 基準價格（新台幣）
  description     String? // 方案描述

  @@index([city, category])

  // Relations
  subscriptions    Subscription[]
  trialConfigs     PromoterTrialConfig[] @relation("TrialPlan")
  trialInvitePlans TrialInvite[]         @relation("TrialInvitePlan")

  @@map("plans")
}

model Subscription {
  id                 String             @id @default(uuid())
  userId             String             @map("user_id")
  planId             String             @map("plan_id")
  status             SubscriptionStatus @default(TRIAL)
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  trialEndsAt        DateTime?          @map("trial_ends_at")
  cancelledAt        DateTime?          @map("cancelled_at")
  cancelReason       String?            @map("cancel_reason")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              Plan               @relation(fields: [planId], references: [id])
  payments          Payment[]
  promoterReferrals PromoterReferral[]
  trialInvites      TrialInvite[]      @relation("TrialSubscription")

  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model Payment {
  id                String          @id @default(uuid())
  subscriptionId    String          @map("subscription_id")
  amount            Int // 金額（新台幣）
  currency          String          @default("TWD")
  status            PaymentStatus   @default(PENDING)
  provider          PaymentProvider
  providerPaymentId String?         @map("provider_payment_id")
  providerData      Json?           @map("provider_data") // 支付商回傳的原始資料
  paidAt            DateTime?       @map("paid_at")
  failedAt          DateTime?       @map("failed_at")
  failureReason     String?         @map("failure_reason")
  refundedAt        DateTime?       @map("refunded_at")
  refundAmount      Int?            @map("refund_amount")
  invoiceNumber     String?         @map("invoice_number") // 發票號碼
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([provider])
  @@index([createdAt])
  @@map("payments")
}

// ==================== 列舉 ====================

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

enum ElectionType {
  VILLAGE_CHIEF
  TOWNSHIP_REP
  CITY_COUNCILOR
  LEGISLATOR
  MAYOR
  PRESIDENT
}

enum PoliticalStance {
  STRONG_SUPPORT
  SUPPORT
  LEAN_SUPPORT
  NEUTRAL
  UNDECIDED
  LEAN_OPPOSE
  OPPOSE
  STRONG_OPPOSE
}

enum PoliticalParty {
  KMT
  DPP
  TPP
  NPP
  TSP
  OTHER
  INDEPENDENT
  UNKNOWN
}

enum Gender {
  M
  F
  OTHER
}

enum RelationType {
  FAMILY
  SPOUSE
  PARENT
  CHILD
  SIBLING
  NEIGHBOR
  FRIEND
  COLLEAGUE
  COMMUNITY
  OTHER
}

enum ContactType {
  HOME_VISIT
  STREET_VISIT
  PHONE_CALL
  LINE_CALL
  LIVING_ROOM
  FUNERAL
  WEDDING
  EVENT
  MARKETPLACE
  TEMPLE
  OTHER
}

enum ContactOutcome {
  POSITIVE
  NEUTRAL
  NEGATIVE
  NO_RESPONSE
  NOT_HOME
}

enum EventType {
  LIVING_ROOM
  FUNERAL
  WEDDING
  COMMUNITY
  TEMPLE
  CAMPAIGN
  MEETING
  OTHER
}

enum EventStatus {
  PLANNED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AttendeeStatus {
  INVITED
  CONFIRMED
  ATTENDED
  NO_SHOW
  CANCELLED
}

enum ScheduleStatus {
  DRAFT
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ScheduleItemType {
  VOTER_VISIT
  EVENT
  STREET_SWEEP
  BREAK
  OTHER
}

enum ScheduleItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum DistrictLevel {
  CITY
  DISTRICT
  VILLAGE
  NEIGHBORHOOD
}

enum PlanInterval {
  MONTH
  YEAR
  LIFETIME
}

enum SubscriptionStatus {
  TRIAL // 試用中
  ACTIVE // 訂閱中
  PAST_DUE // 逾期未付款
  CANCELLED // 已取消
  EXPIRED // 已過期
}

enum PaymentStatus {
  PENDING // 待付款
  PROCESSING // 處理中
  COMPLETED // 已完成
  FAILED // 失敗
  REFUNDED // 已退款
  CANCELLED // 已取消
}

enum PaymentProvider {
  ECPAY // 綠界
  NEWEBPAY // 藍新金流
  STRIPE // Stripe
  MANUAL // 人工處理
}

enum ReferralStatus {
  PENDING // 被推薦人尚未完成付款
  COMPLETED // 被推薦人已付款，獎勵已發放
  EXPIRED // 推薦已過期（超過有效期限未付款）
}

enum PlanCategory {
  VILLAGE_CHIEF // 里長
  REPRESENTATIVE // 民代
  COUNCILOR // 議員
  MAYOR // 市長
  LEGISLATOR // 立委
}

// ==================== 推廣者系統 ====================

model Promoter {
  id           String         @id @default(uuid())
  name         String
  phone        String?
  email        String?
  lineId       String?        @map("line_id")
  referralCode String         @unique @map("referral_code")
  type         PromoterType
  userId       String?        @unique @map("user_id")
  status       PromoterStatus @default(PENDING)
  approvedAt   DateTime?      @map("approved_at")
  approvedBy   String?        @map("approved_by")
  notes        String?
  isActive     Boolean        @default(false) @map("is_active")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Relations
  user         User?                @relation("PromoterUser", fields: [userId], references: [id])
  approver     User?                @relation("PromoterApprover", fields: [approvedBy], references: [id])
  rewardConfig PromoterRewardConfig?
  trialConfig  PromoterTrialConfig?
  referrals    PromoterReferral[]
  shareLinks   ShareLink[]
  trialInvites TrialInvite[]

  @@index([type])
  @@index([status])
  @@index([isActive])
  @@index([createdAt])
  @@map("promoters")
}

model PromoterRewardConfig {
  id                 String     @id @default(uuid())
  promoterId         String     @unique @map("promoter_id")
  rewardType         RewardType
  fixedAmount        Decimal?   @map("fixed_amount") @db.Decimal(10, 2)
  percentage         Decimal?   @db.Decimal(5, 2)
  extensionMonths    Int?       @map("extension_months")
  maxRewardsPerMonth Int?       @map("max_rewards_per_month")
  validFrom          DateTime?  @map("valid_from")
  validUntil         DateTime?  @map("valid_until")
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  promoter Promoter @relation(fields: [promoterId], references: [id], onDelete: Cascade)

  @@map("promoter_reward_configs")
}

model PromoterTrialConfig {
  id                String    @id @default(uuid())
  promoterId        String    @unique @map("promoter_id")
  canIssueTrial     Boolean   @default(true) @map("can_issue_trial")
  minTrialDays      Int       @default(7) @map("min_trial_days")
  maxTrialDays      Int       @default(30) @map("max_trial_days")
  defaultTrialDays  Int       @default(14) @map("default_trial_days")
  trialPlanId       String?   @map("trial_plan_id")
  monthlyIssueLimit Int?      @map("monthly_issue_limit")
  totalIssueLimit   Int?      @map("total_issue_limit")
  validFrom         DateTime? @map("valid_from")
  validUntil        DateTime? @map("valid_until")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  promoter  Promoter @relation(fields: [promoterId], references: [id], onDelete: Cascade)
  trialPlan Plan?    @relation("TrialPlan", fields: [trialPlanId], references: [id])

  @@map("promoter_trial_configs")
}

model ShareLink {
  id         String       @id @default(uuid())
  promoterId String       @map("promoter_id")
  code       String       @unique
  channel    ShareChannel
  targetUrl  String?      @map("target_url")
  clickCount Int          @default(0) @map("click_count")
  isActive   Boolean      @default(true) @map("is_active")
  expiresAt  DateTime?    @map("expires_at")
  createdAt  DateTime     @default(now()) @map("created_at")

  promoter  Promoter           @relation(fields: [promoterId], references: [id], onDelete: Cascade)
  clicks    ShareLinkClick[]
  referrals PromoterReferral[]

  @@index([promoterId])
  @@index([code])
  @@map("share_links")
}

model ShareLinkClick {
  id          String   @id @default(uuid())
  shareLinkId String   @map("share_link_id")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  referer     String?
  clickedAt   DateTime @default(now()) @map("clicked_at")

  shareLink ShareLink @relation(fields: [shareLinkId], references: [id], onDelete: Cascade)

  @@index([shareLinkId])
  @@index([clickedAt])
  @@map("share_link_clicks")
}

model PromoterReferral {
  id              String                 @id @default(uuid())
  promoterId      String                 @map("promoter_id")
  shareLinkId     String?                @map("share_link_id")
  referredUserId  String?                @unique @map("referred_user_id")
  referredName    String?                @map("referred_name")
  referredPhone   String?                @map("referred_phone")
  referredEmail   String?                @map("referred_email")
  channel         ShareChannel?
  status          PromoterReferralStatus @default(CLICKED)
  clickedAt       DateTime?              @map("clicked_at")
  registeredAt    DateTime?              @map("registered_at")
  subscribedAt    DateTime?              @map("subscribed_at")
  renewedAt       DateTime?              @map("renewed_at")
  subscriptionId  String?                @map("subscription_id")
  rewardAmount    Decimal?               @map("reward_amount") @db.Decimal(10, 2)
  rewardGrantedAt DateTime?              @map("reward_granted_at")
  rewardNotes     String?                @map("reward_notes")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")

  promoter     Promoter      @relation(fields: [promoterId], references: [id], onDelete: Cascade)
  shareLink    ShareLink?    @relation(fields: [shareLinkId], references: [id])
  referredUser User?         @relation("PromoterReferred", fields: [referredUserId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([promoterId])
  @@index([status])
  @@index([createdAt])
  @@map("promoter_referrals")
}

model TrialInvite {
  id              String            @id @default(uuid())
  promoterId      String            @map("promoter_id")
  code            String            @unique
  trialDays       Int               @map("trial_days")
  planId          String?           @map("plan_id")
  inviteeName     String?           @map("invitee_name")
  inviteePhone    String?           @map("invitee_phone")
  inviteeEmail    String?           @map("invitee_email")
  inviteMethod    TrialInviteMethod @map("invite_method")
  channel         ShareChannel?
  status          TrialInviteStatus @default(PENDING)
  activatedUserId String?           @unique @map("activated_user_id")
  activatedAt     DateTime?         @map("activated_at")
  expiresAt       DateTime?         @map("expires_at")
  convertedAt     DateTime?         @map("converted_at")
  subscriptionId  String?           @map("subscription_id")
  linkClickCount  Int               @default(0) @map("link_click_count")
  lastClickedAt   DateTime?         @map("last_clicked_at")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  promoter      Promoter      @relation(fields: [promoterId], references: [id], onDelete: Cascade)
  plan          Plan?         @relation("TrialInvitePlan", fields: [planId], references: [id])
  activatedUser User?         @relation("TrialActivatedUser", fields: [activatedUserId], references: [id])
  subscription  Subscription? @relation("TrialSubscription", fields: [subscriptionId], references: [id])

  @@index([promoterId])
  @@index([status])
  @@index([createdAt])
  @@map("trial_invites")
}

enum PromoterType {
  INTERNAL // 訂閱者推廣（現有使用者）
  EXTERNAL // 外部推廣者（非使用者）
}

enum PromoterStatus {
  PENDING   // 待審核
  APPROVED  // 已通過審核
  ACTIVE    // 啟用中
  SUSPENDED // 已停用
}

enum RewardType {
  NONE                   // 無獎勵（純追蹤）
  FIXED_AMOUNT           // 固定金額
  PERCENTAGE             // 訂閱費百分比
  SUBSCRIPTION_EXTENSION // 延長訂閱
}

enum ShareChannel {
  LINE
  FACEBOOK
  SMS
  QR_CODE
  EMAIL
  DIRECT_LINK
  OTHER
}

enum PromoterReferralStatus {
  CLICKED    // 僅點擊連結
  REGISTERED // 已註冊帳號
  TRIAL      // 試用中
  SUBSCRIBED // 已成功訂閱
  RENEWED    // 已續訂
  EXPIRED    // 已過期
}

enum TrialInviteMethod {
  LINK   // 推廣者分享連結
  DIRECT // 推廣者填寫對方資料
}

enum TrialInviteStatus {
  PENDING   // 已建立尚未啟用
  SENT      // 已發送邀請
  ACTIVATED // 已啟用試用
  ACTIVE    // 試用中
  EXPIRED   // 試用到期未轉換
  CONVERTED // 已轉為付費
  CANCELLED // 已取消
}
