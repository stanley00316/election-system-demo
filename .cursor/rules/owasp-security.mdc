---
description: OWASP Top 10 安全合規檢查清單 — 所有後端程式碼必須遵守
globs: apps/api/**/*.ts
alwaysApply: false
---

# OWASP Top 10 安全清單

## A01 存取控制
- 所有 Controller 必須有 `@UseGuards(JwtAuthGuard)` 或 `@Public()`
- 涉及 `campaignId` 的端點必須呼叫 `checkCampaignAccess`
- 禁止 IDOR：查詢資源後必須驗證 `userId` 所有權

## A02 加密
- 禁止硬編碼 secret/fallback（`'fallback-secret'` 等）
- `JWT_SECRET` 啟動時強制驗證 >= 32 字元
- TOTP secret 不回傳前端明文
- 敏感資料必須 AES-256-GCM 加密

## A03 注入
- 使用 Prisma tagged template（`$queryRaw\`...\``），禁止 `$queryRawUnsafe`
- 禁止 `eval()`、`Function()`、`dangerouslySetInnerHTML`
- 全域 `ValidationPipe({ whitelist: true, forbidNonWhitelisted: true })`

## A04 不安全設計
- 所有 DTO 字串欄位加 `@MaxLength()`
- 分頁加 `@Max(100)`
- 付款需冪等性保護 + 狀態機驗證
- 退款必須實際呼叫支付商 API

## A05 安全設定
- 生產環境禁止 Swagger
- `error.message` 禁止回傳客戶端，用 Logger 記錄
- CORS 需明確白名單
- HSTS + helmet + CSP 標頭

## A07 認證失敗
- `JWT_EXPIRES_IN` <= 30m
- JTI 使用 `crypto.randomUUID()`
- 2FA 累計 5 次失敗鎖定 15 分鐘
- Redis 降級：生產環境安全優先（拒絕所有請求）

## A08 資料完整性
- OAuth state 使用 `crypto.getRandomValues()` + sessionStorage 驗證
- Webhook 驗證簽章 + MerchantID

## A10 SSRF
- 付款 returnUrl/clientBackUrl 需域名白名單驗證
